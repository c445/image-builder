#cloud-config
autoinstall:
  version: 1
  early-commands:
    - systemctl stop ssh # otherwise packer tries to connect and exceed max attempts
  locale: en_US.UTF-8
  keyboard:
    layout: us
  storage:
    config:
      - type: disk
        id: disk-0
        size: largest
        grub_device: true
        preserve: false
        ptable: msdos
        wipe: superblock
      - type: partition
        id: partition-0
        device: disk-0
        size: 7G
        number: 1
        preserve: false
        grub_device: false
        flag: boot
      - type: partition
        id: partition-1
        device: disk-0
        size: 2G
        number: 2
        preserve: false
        grub_device: false
        wipe: superblock
      - type: partition
        id: partition-2
        device: disk-0
        size: -1
        number: 3
        preserve: false
        grub_device: false
        wipe: superblock
      - type: format
        id: format-0
        volume: partition-0
        fstype: xfs
        preserve: false
      - type: format
        id: format-1
        volume: partition-1
        fstype: xfs
        preserve: false
      - type: format
        id: format-2
        volume: partition-2
        fstype: xfs
        preserve: false
      - type: mount
        id: mount-0
        device: format-0
        path: /
      - type: mount
        id: mount-1
        device: format-1
        path: /var/log
      - type: mount
        id: mount-2
        device: format-2
        path: /var/lib
  updates: 'all'
  ssh:
    install-server: true
    allow-pw: true
  packages:
    - open-vm-tools
  user-data:
    users:
      - name: builder
        passwd: $6$xyz$UtXVazU08Q5b8AW.TJ3MPYZglyXa3Ttf2RCel8MCUPlEYO1evWxeWBhZ2QqivU/Ij4tqYAxMCqc2ujEM4dMSe1
        groups: [adm, cdrom, dip, plugdev, lxd, sudo]
        lock-passwd: false
        sudo: ALL=(ALL) NOPASSWD:ALL
        shell: /bin/bash
  late-commands:
    - swapoff -a
    - rm -f /swapfile
    - sed -ri '/\sswap\s/s/^#?/#/' /etc/fstab
    - rm -f /etc/udev/rules.d/70-persistent-net.rules
    - apt-get purge --auto-remove -y
    - rm -rf /var/lib/apt/lists/*
